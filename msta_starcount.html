<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Hunter - v1.9.3 (In-Button Boost)</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4ff00; --secondary: #00f2ff; --btn-start: #00d4ff;
            --star-yellow: #ffff00; --danger: #ff3366; --warning: #ffaa00;
            --bg: #0a0a0f; --panel: rgba(255, 255, 255, 0.05); 
            --border: rgba(255, 255, 255, 0.1);
            --bg-red: #450a0a; --bg-orange: #452a00; --bg-green: #0a4520;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background: var(--bg); color: white; margin: 0; 
            display: flex; height: 100vh; overflow: hidden; 
            transition: background-color 0.8s ease; 
        }

        /* --- SIDEBAR --- */
        .sidebar { width: 300px; min-width: 300px; height: 100vh; background: #0d0d12; border-right: 1px solid var(--border); padding: 15px; box-sizing: border-box; overflow-y: auto; z-index: 100; transition: transform 0.3s; }
        .sidebar.collapsed { transform: translateX(-100%); position: absolute; }
        .sidebar-header h2 { color: var(--primary); text-align: center; font-family: 'Bebas Neue'; font-size: 2.2rem; margin: 0 0 10px 0; }
        .menu-section { margin-bottom: 8px; border-radius: 10px; background: var(--panel); border: 1px solid var(--border); overflow: hidden; }
        .menu-header { padding: 10px; cursor: pointer; font-weight: 600; background: rgba(255,255,255,0.03); display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--secondary); }
        .menu-content { padding: 10px; display: none; border-top: 1px solid var(--border); }
        .menu-section.active .menu-content { display: block; }
        
        input[type="number"], input[type="text"], select { width: 100%; background: #000; color: #fff; border: 1px solid var(--border); border-radius: 4px; padding: 6px; box-sizing: border-box; margin-bottom: 8px; }

        /* --- 3D GLASSY TRAFFIC LIGHT --- */
        #traffic-light {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(20px);
            padding: 8px 15px; border-radius: 40px; 
            display: none; flex-direction: row; gap: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .light {
            width: 30px; height: 30px; border-radius: 50%; 
            transition: all 0.4s ease; 
            background: rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .light.red.active { background: radial-gradient(circle, #ff5f6d, #ff3366); box-shadow: 0 0 25px #ff3366; transform: scale(1.1); }
        .light.orange.active { background: radial-gradient(circle, #ffcc33, #ffaa00); box-shadow: 0 0 25px #ffaa00; transform: scale(1.1); }
        .light.green.active { background: radial-gradient(circle, #00ff88, #00c851); box-shadow: 0 0 25px #00c851; transform: scale(1.1); }

        /* --- MAIN SCREEN & TOP CONTROLS --- */
        .main-content { flex-grow: 1; padding: 10px 30px; height: 100vh; display: flex; flex-direction: column; }
        
        #timer-container { 
            height: 100px; 
            display:none; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 5px; 
            width: 100%;
            position: relative;
        }

        .action-buttons-wrapper { display: flex; gap: 10px; align-items: center; }

        .main-btn { padding: 10px 18px; border-radius: 8px; border: none; font-family: 'Bebas Neue'; font-size: 1.1rem; cursor: pointer; height: fit-content; }
        #play-pause-btn { background: var(--btn-start); color: #000; display: none; }
        #boost-btn { background: var(--warning); color: #000; display: none; min-width: 110px; }
        #boost-btn.active { background: #fff; animation: pulse 1s infinite; }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        #main-timer-display { font-family: 'Bebas Neue'; font-size: 70px; color: var(--secondary); margin: 0; position: absolute; left: 50%; transform: translateX(-50%); }

        .student-grid { 
            display: grid; width: 100%; flex-grow: 1; gap: 12px; 
            grid-template-columns: repeat(var(--cols, 4), 1fr); 
            padding: 10px 0; box-sizing: border-box;
        }

        /* --- CARDS & ANIMATIONS --- */
        .student-card { 
            background: linear-gradient(145deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%);
            border: 1px solid var(--border); border-radius: 12px;
            display: flex; flex-direction: column; 
            position: relative; overflow: hidden;
            transition: transform 0.1s, border-color 0.3s;
            cursor: pointer;
        }
        .student-card.is-offline { border-color: var(--warning); background: rgba(255, 170, 0, 0.05); opacity: 0.5; }
        .student-card.point-added { background: rgba(212, 255, 0, 0.15); transform: scale(1.03); border-color: var(--primary); }

        .student-name { 
            background: rgba(255,255,255,0.07);
            padding: 10px 5px; font-weight: 900; 
            font-size: clamp(1.1rem, 2.8vmin, 1.8rem); 
            color: #fff; text-transform: uppercase; text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .timeout-badge {
            background-color: var(--danger);
            color: white; font-size: 0.6em; padding: 2px 6px; border-radius: 4px;
            margin-left: 8px; vertical-align: middle; display: inline-block;
        }

        .card-body { flex-grow: 1; display: flex; justify-content: center; align-items: center; padding: 5px 10px; }
        .score-display { display: flex; align-items: center; justify-content: center; gap: 12px; }
        .star-icon { color: var(--star-yellow); font-size: clamp(1.6rem, 4vmin, 2.5rem); filter: drop-shadow(0 0 8px rgba(255,255,0,0.4)); }
        .star-count { font-family: 'Bebas Neue'; font-size: clamp(2.2rem, 6.5vmin, 4rem); color: var(--secondary); line-height: 1; }

        .card-actions { display: flex; width: 100%; border-top: 1px solid var(--border); background: rgba(0,0,0,0.6); }
        .action-btn { flex: 1; padding: 10px 0; font-size: 10px; border: none; background: transparent; font-weight: 900; text-transform: uppercase; cursor: pointer; transition: 0.2s; color: rgba(255,255,255,0.6); }
        .btn-timeout { color: #ff5555; border-right: 1px solid var(--border) !important; }
        .btn-absent { color: #ffaa00; }

        .rising-star { position: absolute; color: var(--star-yellow); font-size: 4rem; pointer-events: none; z-index: 2000; animation: rise 1s forwards; text-shadow: 0 0 15px gold; }
        @keyframes rise { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-150px) scale(2); opacity: 0; } }

        #editModal { display:none; position:fixed; z-index:4000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.9); align-items:center; justify-content:center; backdrop-filter:blur(8px); }
        .modal-box { background:#15151a; border:1px solid var(--border); padding:25px; border-radius:20px; width:90%; max-width:450px; }
        textarea { width:100%; height:200px; background:#000; color:var(--secondary); border:1px solid var(--border); padding:12px; border-radius:10px; margin:15px 0; font-family:inherit; }
        #menu-toggle-btn { position: fixed; bottom: 15px; left: 15px; z-index: 101; background: var(--panel); border: 1px solid var(--border); color: white; padding: 12px; border-radius: 50%; cursor: pointer; }
        
        .switch { position: relative; display: inline-block; width: 44px; height: 22px; flex-shrink: 0; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .3s; border-radius: 22px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; font-size: 0.85rem; gap: 10px; }
    </style>
</head>
<body>

<div id="editModal">
    <div class="modal-box">
        <h2 id="modalTitle" style="font-family:'Bebas Neue'; color:var(--primary); margin:0; font-size: 2rem;">Bewerken</h2>
        <div id="classNameSection" style="display:none; margin-top:10px;">
            <label id="t-modal-classname" style="font-size: 0.8rem; color: var(--secondary);">Klasnaam:</label>
            <input type="text" id="newClassName">
        </div>
        <textarea id="modalTextarea"></textarea>
        <div style="display:flex; gap:10px;">
            <button id="modalOk" style="flex:1; padding:15px; background:var(--primary); border:none; border-radius:8px; cursor:pointer; font-weight:900;" onclick="closeModal(true)">BEWAREN</button>
            <button style="flex:1; padding:15px; background:transparent; color:white; border:1px solid var(--border); border-radius:8px; cursor:pointer;" onclick="closeModal(false)">ANNULEREN</button>
        </div>
    </div>
</div>

<button id="menu-toggle-btn" onclick="toggleSidebar()">‚öôÔ∏è</button>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h2>STAR HUNTER</h2></div>
    <div class="menu-section">
        <div class="menu-header" onclick="toggleMenuSection(this)" id="t-settings">üåç 1. Instellingen</div>
        <div class="menu-content">
            <div class="row"><label id="t-lang">Taal</label>
                <select id="langSelect" onchange="updateLanguageUI()">
                    <option value="nl">Nederlands</option>
                    <option value="en">English</option>
                    <option value="fr">Fran√ßais</option>
                    <option value="de">Deutsch</option>
                </select>
            </div>
            <div class="row"><label id="t-duration">Lesduur (min)</label><input type="number" id="lessonMinutes" value="20"></div>
        </div>
    </div>
    <div class="menu-section">
        <div class="menu-header" onclick="toggleMenuSection(this)" id="t-extras">üõ†Ô∏è 2. Extra's & Bonus</div>
        <div class="menu-content">
            <div class="row"><label id="t-bonus">Star Pupil Bonus</label><label class="switch"><input type="checkbox" id="starPupilBonusActive" checked><span class="slider"></span></label></div>
            <div class="row"><label id="t-autostar">Auto-ster (Systeem)</label><label class="switch"><input type="checkbox" id="autoStarActive" checked><span class="slider"></span></label></div>
            <div class="row"><label id="t-interval">Interval (sec)</label><input type="number" id="autoStarSec" value="45"></div>
            <div class="row"><label id="t-finalboost">Finale Boost (2x)</label><label class="switch"><input type="checkbox" id="finalBoostActive" checked><span class="slider"></span></label></div>
            <div class="row"><label id="t-boosttime">Boost start (sec)</label><input type="number" id="finalBoostTime" value="60"></div>
            <div class="row"><label id="t-traffic">Stoplicht tonen</label><label class="switch"><input type="checkbox" id="showTraffic" onchange="toggleTraffic()"><span class="slider"></span></label></div>
            <button id="t-editrewards" style="width:100%; padding:8px; border-radius:6px; background:var(--panel); color:white; border:1px solid var(--border); cursor:pointer;" onclick="openEditModal('rewards')">BONUSPOTT</button>
        </div>
    </div>
    <div class="menu-section">
        <div class="menu-header" onclick="toggleMenuSection(this)" id="t-classmgmt">üéì 3. Klassenbeheer</div>
        <div class="menu-content">
            <select id="savedClasses" onchange="loadSelectedClass()"></select>
            <button onclick="openEditModal('new_class')" style="width:100%; padding:8px; background:var(--primary); color:black; border:none; border-radius:4px; font-weight:bold; cursor:pointer; margin-top:5px;">+ NIEUWE KLAS</button>
            <button id="t-editstudents" style="width:100%; padding:10px; margin-top:8px; border-radius:6px; background:rgba(212,255,0,0.1); color:var(--primary); border:1px solid var(--primary); font-weight: bold;" onclick="openEditModal('students')">üìù BEWERK HUIDIGE KLAS</button>
        </div>
    </div>
    <button id="t-startsession" onclick="initGame()" style="width:100%; padding:15px; background:var(--btn-start); color:black; border:none; font-family:'Bebas Neue'; font-size:1.5rem; cursor:pointer; border-radius:10px; margin-top:10px;">START SESSIE</button>
</div>

<div class="main-content">
    <div id="timer-container">
        <div id="traffic-light" onclick="cycleTraffic()">
            <div class="light green"></div>
            <div class="light orange"></div>
            <div class="light red"></div>
        </div>

        <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;">
            <h1 id="main-timer-display">00:00</h1>
        </div>

        <div class="action-buttons-wrapper">
            <button id="boost-btn" class="main-btn" onclick="triggerManualBoost()">üöÄ BOOST!</button>
            <button id="play-pause-btn" class="main-btn" onclick="togglePlayPause()">‚ñ∂ START LES</button>
            <button id="end-session-main" class="main-btn" onclick="endGame()" style="background:var(--danger); display:none;">STOP</button>
        </div>
    </div>

    <div id="grid" class="student-grid"></div>
</div>

<div id="end-screen" style="position:fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:3000;">
    <div id="winner-display" style="text-align:center;"></div>
    <button id="claim-bonus-btn" onclick="startBonusSpin()" style="background:var(--star-yellow); color:black; padding:20px 40px; border:none; border-radius:15px; font-family:'Bebas Neue'; font-size:2.5rem; cursor:pointer; display:none; margin-top:30px; box-shadow: 0 0 30px yellow;">OPEN JE BONUS üéÅ</button>
    <div id="bonus-container" style="margin-top:20px; text-align:center; display:none;">
        <div id="slot-result" style="font-family:'Bebas Neue'; font-size:4rem; color:var(--primary);">???</div>
    </div>
    <button onclick="location.reload()" style="background:var(--panel); color:white; margin-top:40px; padding:10px 20px; border:1px solid var(--border); border-radius:8px; cursor:pointer;">NIEUWE SESSIE</button>
</div>

<script>
    const i18n = {
        nl: { settings: "üåç 1. Instellingen", lang: "Taal", duration: "Lesduur (min)", extras: "üõ†Ô∏è 2. Extra's & Bonus", bonus: "Star Pupil Bonus", autostar: "Auto-ster (Systeem)", interval: "Interval (sec)", finalboost: "Finale Boost (2x)", boosttime: "Boost start (sec)", traffic: "Stoplicht tonen", editrewards: "BEWERK BONUSPOT", classmgmt: "üéì 3. Klassenbeheer", editstudents: "üìù BEWERK HUIDIGE KLAS", startsession: "START SESSIE", startlesson: "‚ñ∂ START LES", pause: "‚è∏ PAUZE", winner: "WINNAAR", to: "TIME-OUT", afw: "AFWEZIG" },
        en: { settings: "üåç 1. Settings", lang: "Language", duration: "Duration (min)", extras: "üõ†Ô∏è 2. Extras & Bonus", bonus: "Star Pupil Bonus", autostar: "Auto-star (System)", interval: "Interval (sec)", finalboost: "Final Boost (2x)", boosttime: "Boost start (sec)", traffic: "Show Traffic Light", editrewards: "EDIT REWARDS", classmgmt: "üéì 3. Classes", editstudents: "üìù EDIT CURRENT CLASS", startsession: "START SESSION", startlesson: "‚ñ∂ START LESSON", pause: "‚è∏ PAUSE", winner: "WINNER", to: "TIME-OUT", afw: "ABSENT" },
        fr: { settings: "üåç 1. Param√®tres", lang: "Langue", duration: "Dur√©e (min)", extras: "üõ†Ô∏è 2. Extras & Bonus", bonus: "Bonus Star Pupil", autostar: "Auto-√©toile", interval: "Intervalle (sec)", finalboost: "Boost Final", boosttime: "D√©but Boost (sec)", traffic: "Afficher le feu", editrewards: "MODIFIER PRIX", classmgmt: "üéì 3. Gestion", editstudents: "üìù LISTE √âL√àVES", startsession: "D√âMARRER", startlesson: "‚ñ∂ COMMENCER", pause: "‚è∏ PAUSE", winner: "GAGNANT", to: "EXCLUSION", afw: "ABSENT" },
        de: { settings: "üåç 1. Einstellungen", lang: "Sprache", duration: "Dauer (Min)", extras: "üõ†Ô∏è 2. Extras & Bonus", bonus: "Star Pupil Bonus", autostar: "Auto-Stern", interval: "Intervall (Sek)", finalboost: "Finaler Boost", boosttime: "Boost Start (Sek)", traffic: "Ampel zeigen", editrewards: "BEARBEITEN", classmgmt: "üéì 3. Verwaltung", editstudents: "üìù SCH√úLERLISTE", startsession: "STARTEN", startlesson: "‚ñ∂ START", pause: "‚è∏ PAUSE", winner: "GEWINNER", to: "AUSZEIT", afw: "ABWESEND" }
    };

    let currentClass = "", currentStudentsRaw = "", currentRewardsRaw = "Extra pauze\nSticker\nKies je plek\nHuiswerkvrij pas\nSnoepje\nMuziek keuze";
    let editMode = "", students = [], isPaused = true, sessionEnded = false, mainTimer = null, secondsRemaining = 0, autoStarTimer = null, manualBoostActive = false, manualBoostSeconds = 0, trafficState = 0;

    function cycleTraffic() {
        trafficState = (trafficState + 1) % 4;
        const lights = document.querySelectorAll('.light');
        lights.forEach(l => l.classList.remove('active'));
        if (trafficState === 0) { document.body.style.backgroundColor = "var(--bg)"; }
        else if (trafficState === 1) { lights[0].classList.add('active'); document.body.style.backgroundColor = "var(--bg-green)"; }
        else if (trafficState === 2) { lights[1].classList.add('active'); document.body.style.backgroundColor = "var(--bg-orange)"; }
        else if (trafficState === 3) { lights[2].classList.add('active'); document.body.style.backgroundColor = "var(--bg-red)"; }
    }

    function toggleTraffic() { document.getElementById('traffic-light').style.display = document.getElementById('showTraffic').checked ? 'flex' : 'none'; }
    function updateLanguageUI() { const l = document.getElementById('langSelect').value; const d = i18n[l]; for (let id in d) { const el = document.getElementById('t-' + id); if (el) el.innerText = d[id]; } }
    function refreshClassDropdown() { const drp = document.getElementById('savedClasses'); const all = JSON.parse(localStorage.getItem('starHunter_v13') || '{}'); drp.innerHTML = '<option value="">-- Kies klas --</option>'; for (let n in all) { const o = document.createElement('option'); o.value = n; o.innerText = n; if(n === currentClass) o.selected = true; drp.appendChild(o); } }
    function loadSelectedClass() { currentClass = document.getElementById('savedClasses').value; const all = JSON.parse(localStorage.getItem('starHunter_v13') || '{}'); currentStudentsRaw = all[currentClass] || ""; }
    function openEditModal(t) { editMode = t; const txt = document.getElementById('modalTextarea'); document.getElementById('classNameSection').style.display = (t === 'new_class') ? 'block' : 'none'; if (t === 'students') txt.value = currentStudentsRaw; else if (t === 'rewards') txt.value = currentRewardsRaw; else { txt.value = ""; document.getElementById('newClassName').value = ""; } document.getElementById('editModal').style.display = 'flex'; }
    function closeModal(s) { if (s) { const v = document.getElementById('modalTextarea').value; let all = JSON.parse(localStorage.getItem('starHunter_v13') || '{}'); if (editMode === 'students' && currentClass) { currentStudentsRaw = v; all[currentClass] = v; localStorage.setItem('starHunter_v13', JSON.stringify(all)); } else if (editMode === 'rewards') currentRewardsRaw = v; else if (editMode === 'new_class') { const n = document.getElementById('newClassName').value.trim(); if(n && v) { all[n] = v; localStorage.setItem('starHunter_v13', JSON.stringify(all)); currentClass = n; currentStudentsRaw = v; } } refreshClassDropdown(); } document.getElementById('editModal').style.display = 'none'; }

    function initGame() {
        const names = currentStudentsRaw.split('\n').filter(n => n.trim() !== "");
        if (names.length === 0) return;
        students = names.map(n => ({ name: n.trim(), stars: 0, isOffline: false, isAbsent: false, timeoutCount: 0 }));
        sessionEnded = false;
        toggleSidebar(); 
        document.getElementById('play-pause-btn').style.display = 'block'; 
        document.getElementById('boost-btn').style.display = 'block';
        document.getElementById('end-session-main').style.display = 'block';
        secondsRemaining = (parseInt(document.getElementById('lessonMinutes').value) || 20) * 60;
        document.getElementById('timer-container').style.display = 'flex';
        renderGrid();
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        const lang = document.getElementById('langSelect').value;
        const ratio = (window.innerWidth - 20) / (window.innerHeight - 150);
        let cols = Math.ceil(Math.sqrt(students.length * ratio)); 
        grid.style.setProperty('--cols', cols);
        students.forEach((s, i) => {
            if (s.isAbsent) return;
            const card = document.createElement('div');
            card.className = `student-card ${s.isOffline ? 'is-offline' : ''}`;
            card.onclick = () => { if(!isPaused && !s.isOffline && !sessionEnded) addStar(i); };
            const toBadge = s.timeoutCount > 0 ? `<span class="timeout-badge">${s.timeoutCount}x</span>` : '';
            card.innerHTML = `<div class="student-name">${s.name} ${toBadge}</div><div class="card-body"><div class="score-display"><div class="star-icon">‚òÖ</div><div class="star-count" id="star-count-${i}">${s.stars}</div></div></div><div class="card-actions"><button class="action-btn btn-timeout" onclick="event.stopPropagation(); toggleStat(${i},'to')">${i18n[lang].to}</button><button class="action-btn btn-absent" onclick="event.stopPropagation(); toggleStat(${i},'afw')">${i18n[lang].afw}</button></div>`;
            grid.appendChild(card);
        });
    }

    function addStar(i) {
        if(sessionEnded) return;
        const thres = parseInt(document.getElementById('finalBoostTime').value) || 60;
        const isFinal = (document.getElementById('finalBoostActive').checked && secondsRemaining <= thres);
        const mult = (isFinal || manualBoostActive) ? 2 : 1;
        students[i].stars += mult;
        const countEl = document.getElementById(`star-count-${i}`);
        if(countEl) countEl.innerText = students[i].stars;
        const cards = document.querySelectorAll('.student-card');
        let cardIdx = 0; for(let j=0; j<i; j++) { if(!students[j].isAbsent) cardIdx++; }
        const card = Array.from(cards)[cardIdx];
        if(card) { card.classList.add('point-added'); setTimeout(() => card.classList.remove('point-added'), 300); spawnRisingStar(card); }
    }

    function spawnRisingStar(target) {
        const star = document.createElement('div'); star.className = 'rising-star'; star.innerText = '‚òÖ';
        const rect = target.getBoundingClientRect();
        star.style.left = `${rect.left + rect.width / 2 - 30}px`; star.style.top = `${rect.top + 20}px`;
        document.body.appendChild(star); setTimeout(() => star.remove(), 1000);
    }

    function toggleStat(i, type) { 
        if(type === 'to') { if(!students[i].isOffline) students[i].timeoutCount++; students[i].isOffline = !students[i].isOffline; } 
        else { students[i].isAbsent = true; }
        renderGrid(); 
    }

    function togglePlayPause() { 
        isPaused = !isPaused; 
        const l = document.getElementById('langSelect').value; 
        document.getElementById('play-pause-btn').innerText = isPaused ? i18n[l].startlesson : i18n[l].pause; 
        if (!isPaused) { 
            mainTimer = setInterval(() => { secondsRemaining--; if (manualBoostActive) manualBoostSeconds--; updateTimer(); if (secondsRemaining <= 0) endGame(); }, 1000); 
            if (document.getElementById('autoStarActive').checked) startAutoStar(); 
        } else { clearInterval(mainTimer); clearTimeout(autoStarTimer); } 
    }

    function updateTimer() { 
        const m = Math.floor(secondsRemaining / 60); const s = secondsRemaining % 60; 
        document.getElementById('main-timer-display').innerText = `${m}:${s.toString().padStart(2,'0')}`; 
        
        const boostBtn = document.getElementById('boost-btn');
        if (manualBoostActive && manualBoostSeconds <= 0) { 
            manualBoostActive = false; 
            boostBtn.classList.remove('active'); 
            boostBtn.innerText = "üöÄ BOOST!";
        } 
        else if (manualBoostActive) { 
            const bm = Math.floor(manualBoostSeconds / 60); 
            const bs = manualBoostSeconds % 60; 
            boostBtn.innerText = `üöÄ ${bm}:${bs.toString().padStart(2,'0')}`;
        } 
    }

    function triggerManualBoost() { if (isPaused || manualBoostActive) return; manualBoostActive = true; manualBoostSeconds = 120; document.getElementById('boost-btn').classList.add('active'); updateTimer(); }
    function startAutoStar() { if (isPaused || sessionEnded) return; autoStarTimer = setTimeout(() => { const act = students.map((s, idx) => (!s.isOffline && !s.isAbsent) ? idx : null).filter(v => v !== null); if (act.length > 0) addStar(act[Math.floor(Math.random() * act.length)]); startAutoStar(); }, (parseInt(document.getElementById('autoStarSec').value) || 45) * 1000); }
    
    function endGame() { 
        sessionEnded = true; clearInterval(mainTimer); 
        document.querySelectorAll('.rising-star').forEach(el => el.remove());
        const winners = [...students].sort((a,b) => b.stars - a.stars); 
        document.getElementById('winner-display').innerHTML = `<h1 style="color:var(--primary); font-family:'Bebas Neue'; font-size:5rem;">WINNAAR: ${winners[0].name}</h1>`; 
        document.getElementById('end-screen').style.display = 'flex'; 
        var duration = 3000; var end = Date.now() + duration;
        (function frame() {
            confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 }, colors: ['#d4ff00', '#00f2ff', '#ffffff'], zIndex: 4000 });
            confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 }, colors: ['#d4ff00', '#00f2ff', '#ffffff'], zIndex: 4000 });
            if (Date.now() < end) { requestAnimationFrame(frame); }
        }());
        if (document.getElementById('starPupilBonusActive').checked) document.getElementById('claim-bonus-btn').style.display = 'block'; 
    }

    function startBonusSpin() { document.getElementById('claim-bonus-btn').style.display = 'none'; document.getElementById('bonus-container').style.display = 'block'; const r = currentRewardsRaw.split('\n').filter(x => x.trim() !== ""); let c = 0; const iv = setInterval(() => { document.getElementById('slot-result').innerText = r[Math.floor(Math.random() * r.length)]; if (++c > 20) { clearInterval(iv); confetti({ particleCount: 100, zIndex: 4000 }); } }, 100); }
    function toggleMenuSection(h) { h.parentElement.classList.toggle('active'); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }

    refreshClassDropdown();
    updateLanguageUI();
</script>
</body>
</html>



