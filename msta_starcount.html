<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Star Hunter - Confetti Fix</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Outfit:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4ff00; --secondary: #00f2ff; --star-yellow: #ffff00; 
            --danger: #ff3366; --success: #2ecc71; --double: #ffaa00; --bg: #0a0a0f;
            --panel: rgba(255, 255, 255, 0.08); --border: rgba(255, 255, 255, 0.12);
        }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: white; margin: 0; display: flex; height: 100vh; overflow: hidden; transition: background 0.5s ease; }
        body.double-active { background: radial-gradient(circle at 50% 50%, #1a1205 0%, #0a0a0f 100%); outline: 6px solid var(--double); outline-offset: -6px; }
        
        /* Sidebar & Menu */
        .sidebar { width: 260px; background: rgba(10, 10, 15, 0.98); backdrop-filter: blur(15px); padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 100; transition: transform 0.3s ease; }
        .sidebar.collapsed { transform: translateX(-100%); position: absolute; }
        
        .top-controls { position: fixed; top: 15px; right: 15px; z-index: 101; display: flex; gap: 8px; }
        .main-btn { border: none; color: white; padding: 10px 16px; border-radius: 6px; font-family: 'Bebas Neue', sans-serif; font-size: 1.1rem; cursor: pointer; transition: 0.2s; }
        #end-session-main { background: var(--danger); display: none; }
        #quick-boost-btn { background: var(--double); color: #000; display: none; }

        #menu-toggle-btn { position: fixed; bottom: 15px; left: 15px; z-index: 101; background: var(--panel); border: 1px solid var(--border); color: var(--secondary); padding: 10px 14px; border-radius: 50%; cursor: pointer; }

        .main-content { flex-grow: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; position: relative; }
        #timer-container { text-align: center; padding: 5px 0; display: none; margin-bottom: 10px; }
        #main-timer-display { font-family: 'Bebas Neue', sans-serif; font-size: 3.5rem; color: var(--secondary); line-height: 1; }
        
        #event-text { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--double); display: none; animation: pulse 0.6s infinite alternate; }
        @keyframes pulse { from { opacity: 0.6; transform: scale(0.98); } to { opacity: 1; transform: scale(1.02); } }

        .student-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; width: 100%; max-width: 1200px; }
        .student-card { background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; align-items: center; transition: 0.2s; cursor: pointer; position: relative; }
        .student-card.is-offline { opacity: 0.3; filter: grayscale(1); }
        .student-card.active-star { background: rgba(255,255,255,0.15); border-color: var(--star-yellow); transform: scale(1.05); }
        
        .student-name { font-size: 0.95rem; font-weight: 600; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%; }
        .star-count { font-size: 2.2rem; font-weight: 800; color: var(--secondary); margin: 5px 0; }
        .yellow-star { color: var(--star-yellow); font-size: 1.5rem; }
        .timeout-btn { font-size: 0.6rem; padding: 4px 6px; border-radius: 4px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%; margin-top: 5px; }

        /* End Screen */
        #end-screen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            display: none; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 200; background: var(--bg);
        }
        .winner-card { 
            text-align: center; padding: 40px; border-radius: 24px; 
            background: rgba(255, 255, 255, 0.05); border: 2px solid var(--border);
            box-shadow: 0 0 50px rgba(0,0,0,0.5); transform: scale(0.8); animation: zoomIn 0.5s forwards ease-out;
        }
        @keyframes zoomIn { to { transform: scale(1); } }

        .floating-star { position: absolute; pointer-events: none; color: var(--star-yellow); font-size: 1.5rem; animation: floatUp 0.7s forwards ease-out; z-index: 10; }
        @keyframes floatUp { 0% { transform: translateY(0) scale(1); opacity: 1; } 100% { transform: translateY(-50px) scale(1.5); opacity: 0; } }

        .option-group { background: rgba(255,255,255,0.04); padding: 10px; border-radius: 8px; margin-bottom: 10px; border: 1px solid var(--border); }
        .sidebar label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; }
        .btn-start { width: 100%; padding: 12px; background: var(--primary); color: #000; border: none; font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; cursor: pointer; border-radius: 6px; }
        textarea { flex-grow: 1; background: rgba(0,0,0,0.3); color: #fff; border: 1px solid var(--border); padding: 10px; resize: none; font-size: 0.8rem; margin-bottom: 10px; }
        input[type="number"], select { background:#000; color:#fff; border:1px solid var(--border); border-radius:4px; padding:2px; font-size: 0.8rem; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="top-controls">
    <button id="quick-boost-btn" class="main-btn" onclick="triggerManualBoost()">⚡ SURPRISE BOOST</button>
    <button id="end-session-main" class="main-btn" onclick="endGame()">STOP</button>
</div>

<button id="menu-toggle-btn" onclick="toggleSidebar()">⚙️</button>

<div class="sidebar" id="sidebar">
    <h2 style="color:var(--primary); text-align:center; font-family:'Bebas Neue'; font-size: 2rem; margin-bottom: 10px;">STAR HUNTER</h2>
    <div id="setup-options">
        <div class="option-group">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label id="lbl-lang">TAAL</label>
                <select id="langSelect" onchange="updateLanguage()">
                    <option value="NL">NL</option><option value="EN">EN</option><option value="FR">FR</option><option value="DU">DU</option>
                </select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <label id="lbl-timer">TIMER</label>
                <input type="checkbox" id="useTimer" checked onchange="document.getElementById('timerSettings').classList.toggle('hidden', !this.checked)">
            </div>
        </div>
        <div id="timerSettings" class="option-group">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                <label id="lbl-mins">MINUTEN:</label>
                <input type="number" id="lessonMinutes" value="20" style="width:40px;">
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                <label id="lbl-auto">AUTO BOOST</label>
                <input type="checkbox" id="enableAutoDouble" checked>
            </div>
            <div style="display:flex; justify-content:space-between;">
                <label id="lbl-last">LAATSTE (MIN):</label>
                <input type="number" id="doubleMinutes" value="5" style="width:40px;">
            </div>
        </div>
    </div>
    <select id="classSelect" onchange="switchClass()" style="width:100%; padding:8px; margin-bottom:10px;"></select>
    <textarea id="studentInput" placeholder="Namen per regel..." oninput="saveCurrentData();"></textarea>
    <button id="startBtn" class="btn-start" onclick="initGame()">START</button>
</div>

<div class="main-content">
    <div id="timer-container">
        <div id="main-timer-display">00:00</div>
        <div id="event-text">★ x2 BOOST ★</div>
    </div>
    <div id="grid" class="student-grid"></div>
    <div id="end-screen">
        <div class="winner-card" id="winner-card-content"></div>
    </div>
</div>

<script>
    const dictionary = {
        NL: { title: "TODAY'S STAR PUPIL:", stop: "STOP", boost: "⚡ SURPRISE BOOST", menu: "MENU", online: "ONLINE", offline: "TIMEOUT", lang: "TAAL", mins: "MINUTEN", last: "LAATSTE (MIN)" },
        EN: { title: "TODAY'S STAR PUPIL:", stop: "STOP", boost: "⚡ SURPRISE BOOST", menu: "MENU", online: "ONLINE", offline: "TIMEOUT", lang: "LANGUAGE", mins: "MINUTES", last: "LAST (MIN)" },
        FR: { title: "L'ÉLÈVE VEDETTE DU JOUR :", stop: "ARRÊTER", boost: "⚡ BOOST SURPRISE", menu: "MENU", online: "EN LIGNE", offline: "PAUSE", lang: "LANGUE", mins: "MINUTES", last: "DERNIÈRES (MIN)" },
        DU: { title: "DER HEUTIGE STAR-SCHÜLER:", stop: "STOPP", boost: "⚡ ÜBERRASCHUNGS-BOOST", menu: "MENÜ", online: "ONLINE", offline: "TIMEOUT", lang: "SPRACHE", mins: "MINUTEN", last: "LETZTE (MIN)" }
    };

    let students = [], gameActive = false, isDoubleActive = false, mainTimer = null, boostTimer = null, secondsRemaining = 0, currentLang = "NL";
    let classes = JSON.parse(localStorage.getItem('sh_classes')) || { "Klas 1": "" };
    let currentClassName = localStorage.getItem('sh_currentClass') || "Klas 1";

    function updateLanguage() {
        currentLang = document.getElementById('langSelect').value;
        const d = dictionary[currentLang];
        document.getElementById('end-session-main').innerText = d.stop;
        document.getElementById('quick-boost-btn').innerText = d.boost;
        document.getElementById('lbl-lang').innerText = d.lang;
        document.getElementById('lbl-mins').innerText = d.mins;
        document.getElementById('lbl-last').innerText = d.last;
        if (gameActive) renderGrid();
    }

    function initClassManager() {
        const select = document.getElementById('classSelect');
        select.innerHTML = '';
        Object.keys(classes).forEach(c => {
            const opt = document.createElement('option'); opt.value = c; opt.innerText = c;
            if (c === currentClassName) opt.selected = true;
            select.appendChild(opt);
        });
        document.getElementById('studentInput').value = classes[currentClassName] || "";
    }

    function switchClass() {
        currentClassName = document.getElementById('classSelect').value;
        document.getElementById('studentInput').value = classes[currentClassName] || "";
    }

    function saveCurrentData() {
        classes[currentClassName] = document.getElementById('studentInput').value;
        localStorage.setItem('sh_classes', JSON.stringify(classes));
    }

    function triggerManualBoost() {
        if (!gameActive || isDoubleActive) return;
        isDoubleActive = true;
        document.getElementById('event-text').style.display = 'block';
        document.body.classList.add('double-active');
        setTimeout(() => {
            isDoubleActive = false;
            document.getElementById('event-text').style.display = 'none';
            document.body.classList.remove('double-active');
        }, 30000); 
    }

    function initGame() {
        const names = document.getElementById('studentInput').value.split('\n').filter(n => n.trim() !== "");
        if (names.length === 0) return;
        students = names.map(name => ({ name: name.trim(), stars: 0, systemStars: 0, isOffline: false }));
        
        if (document.getElementById('useTimer').checked) {
            document.getElementById('timer-container').style.display = 'block';
            secondsRemaining = (parseInt(document.getElementById('lessonMinutes').value) || 20) * 60;
            mainTimer = setInterval(() => {
                secondsRemaining--;
                const mins = Math.floor(secondsRemaining / 60), secs = secondsRemaining % 60;
                document.getElementById('main-timer-display').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                if (secondsRemaining <= 0) endGame();
            }, 1000);
        }
        gameActive = true;
        document.getElementById('setup-options').classList.add('hidden');
        document.getElementById('startBtn').classList.add('hidden');
        document.getElementById('end-session-main').style.display = 'block';
        document.getElementById('quick-boost-btn').style.display = 'block';
        document.getElementById('sidebar').classList.add('collapsed');
        renderGrid();
        gameLoop();
    }

    function renderGrid() {
        const grid = document.getElementById('grid'); grid.innerHTML = '';
        students.forEach((s, i) => {
            const card = document.createElement('div');
            card.className = `student-card ${s.isOffline ? 'is-offline' : ''}`;
            card.onclick = (e) => { if (e.target.tagName !== 'BUTTON') addStar(i, isDoubleActive ? 2 : 1, false); };
            card.innerHTML = `<div class="student-name">${s.name}</div><div class="star-count"><span class="yellow-star">★</span><span id="stars-${i}">${s.stars}</span></div>
                <button class="timeout-btn" style="background:${s.isOffline ? 'var(--success)':'var(--danger)'}; color:white;" onclick="event.stopPropagation(); students[${i}].isOffline = !students[${i}].isOffline; renderGrid();">
                    ${s.isOffline ? dictionary[currentLang].online : dictionary[currentLang].offline}
                </button>`;
            grid.appendChild(card);
        });
    }

    function gameLoop() {
        if (!gameActive) return;
        const online = students.map((s, i) => ({...s, id: i})).filter(s => !s.isOffline);
        if (online.length > 0) {
            const min = Math.min(...online.map(s => s.systemStars));
            const candidates = online.filter(s => s.systemStars === min);
            addStar(candidates[Math.floor(Math.random()*candidates.length)].id, isDoubleActive ? 2 : 1, true);
        }
        setTimeout(gameLoop, Math.random() * 8000 + 4000);
    }

    function addStar(index, amount, isSys) {
        if (students[index].isOffline) return;
        students[index].stars += amount; if (isSys) students[index].systemStars += amount;
        const card = document.querySelectorAll('.student-card')[index];
        if(card) {
            card.classList.add('active-star');
            const star = document.createElement('div'); star.className = 'floating-star'; star.innerText = amount >= 2 ? '★★' : '★';
            card.appendChild(star); document.getElementById(`stars-${index}`).innerText = students[index].stars;
            setTimeout(() => { star.remove(); card.classList.remove('active-star'); }, 700);
        }
    }

    function endGame() {
        gameActive = false; clearInterval(mainTimer);
        const d = dictionary[currentLang];
        const winner = [...students].sort((a,b) => b.stars - a.stars)[0];
        const screen = document.getElementById('end-screen');
        const card = document.getElementById('winner-card-content');
        
        card.innerHTML = `
            <h1 style="color:var(--primary); font-family:'Bebas Neue'; font-size:2rem; margin:0;">${d.title}</h1>
            <h2 style="font-size:4.5rem; margin:10px 0; text-shadow:0 0 30px var(--primary);">${winner ? winner.name : '---'}</h2>
            <div style="font-size:3rem; color:var(--star-yellow); font-family:'Bebas Neue';">★ ${winner ? winner.stars : 0}</div>
            <button class="main-btn" onclick="location.reload()" style="background:var(--secondary); color:#000; margin-top:20px; width:100%; font-size:1.4rem;">${d.menu}</button>
        `;
        
        screen.style.display = 'flex';

        // --- VERBETERDE CONFETTI ---
        setTimeout(() => {
            const colors = ['#d4ff00', '#00f2ff', '#ffff00', '#ffffff'];
            
            // 1. De grote knal
            confetti({
                particleCount: 150,
                spread: 70,
                origin: { y: 0.6 },
                colors: colors,
                zIndex: 999
            });

            // 2. De zij-kanonnen die even doorgaan
            const duration = 3000;
            const animationEnd = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 2,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0, y: 0.8 },
                    colors: colors,
                    zIndex: 999
                });
                confetti({
                    particleCount: 2,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1, y: 0.8 },
                    colors: colors,
                    zIndex: 999
                });

                if (Date.now() < animationEnd) {
                    requestAnimationFrame(frame);
                }
            }());
        }, 100); // Vertraging voor rendering
    }

    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('collapsed'); }
    initClassManager();
    updateLanguage();
</script>
</body>
</html>

